FROM node:latest

ARG SMTP_SERVER
ENV SMTP_SERVER=$SMTP_SERVER

ARG SMPT_PORT
ENV SMPT_PORT=$SMTP_PORT

ARG SMTP_SECURE
ENV SMTP_SECURE=$SMTP_SECURE

ARG SMTP_USER
ENV SMTP_USER=$SMTP_USER

ARG SMTP_PASS
ENV SMTP_PASS=$SMTP_PASS

ARG POSTGRES_CONNECTION_URL
ENV POSTGRES_CONNECTION_URL=$POSTGRES_CONNECTION_URL

ARG AUTH_SERVICE_BASE_URL
ENV AUTH_SERVICE_BASE_URL=$AUTH_SERVICE_BASE_URL

ENV AUTH_SERVICE_PORT=5000

ARG AUTH_SERVICE_JWT_ISSUER
ARG AUTH_SERVICE_JWT_ISSUER=$AUTH_SERVICE_JWT_ISSUER

ARG AUTH_SERVICE_JWT_EXP_IN_SEC
ENV AUTH_SERVICE_JWT_EXP_IN_SEC=$AUTH_SERVICE_JWT_EXP_IN_SEC

ARG AUTH_SERVICE_ROTATE_EVERY_N_SECONDS
ENV AUTH_SERVICE_ROTATE_EVERY_N_SECONDS=$AUTH_SERVICE_ROTATE_EVERY_N_SECONDS

ARG AUTH_SERVICE_GRAPHQL_SCHEMA
ENV AUTH_SERVICE_GRAPHQL_SCHEMA=$AUTH_SERVICE_GRAPHQL_SCHEMA

RUN git clone https://github.com/omoearth/omo-auth.git
RUN cd omo-auth/auth && ./rebuild.sh

RUN set POSTGRES_CONNECTION_URL=`postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@localhost:5432/${POSTGRES_DB}?schema=public`

EXPOSE 5000/tcp

CMD ["node", "omo-auth/auth/server/dist/main.js"]
